<script lang="ts">
  import {
    Accordion,
    AccordionItem,
    SlideToggle,
    modalStore,
    type ModalSettings
  } from '@skeletonlabs/skeleton'
  import { db } from '../../db/db'
  import { liveQuery } from 'dexie'
  import classNames from 'classnames'
  import { Dices, TrashIcon } from 'lucide-svelte'
  import { isDraggingAddon } from '../../stores/library'
  import { currentGameManifest } from '../../stores/manifest'
  import AddonCard from '../addons/AddonCard.svelte'
  import { activeProfileStore } from '../../stores/active-profile'
  import { toggleAddonIdInShuffle, toggleShuffleEnabled } from '../../utils/shuffles'

  function drop(event: DragEvent, shuffleId: number) {
    const json = event.dataTransfer.getData('text/plain')
    const data = JSON.parse(json)

    toggleAddonIdInShuffle(shuffleId, data.addonId)
    event.preventDefault()
  }

  function promptCreateShuffle() {
    const createShuffleModal: ModalSettings = {
      type: 'prompt',
      // Data
      title: 'Create shuffle',
      body: 'Please name your new shuffle.',
      value: '',
      valueAttr: { type: 'text', minlength: 1, maxlength: 32, required: true },
      // Returns the updated response value
      response: (r: string) => {
        if (r) {
          db.shuffles.add({
            shuffledAddonIds: [],
            label: r
          })
        }
      }
    }
    modalStore.trigger(createShuffleModal)
  }

  function promptShuffleRename(shuffleId: number, currentName: string) {
    const renameShuffleModal: ModalSettings = {
      type: 'prompt',
      // Data
      title: 'Rename shuffle',
      body: `Rename shuffle "${currentName}" to:`,
      value: currentName,
      valueAttr: { type: 'text', minlength: 1, maxlength: 32, required: true },
      // Returns the updated response value
      response: (r: string) => {
        if (r) {
          db.shuffles.update(shuffleId, { label: r })
        }
      }
    }
    modalStore.trigger(renameShuffleModal)
  }

  function promptShuffleDelete(shuffleId: number, currentName: string) {
    const renameShuffleModal: ModalSettings = {
      type: 'confirm',
      // Data
      title: 'Delete shuffle',
      body: `Are you sure you want to delete the shuffle "${currentName}"?`,
      response: (r: boolean) => {
        if (r) {
          db.shuffles.delete(shuffleId)
        }
      }
    }
    modalStore.trigger(renameShuffleModal)
  }

  const shuffles = liveQuery(() => db.shuffles.toArray())
</script>

<div class="w-[30vw] max-w-[600px] min-h-[100%] flex flex-col bg-surface-800">
  <div
    class="flex sticky top-0 justify-between items-center px-4 py-3 bg-surface-800/80 backdrop-blur-lg z-10"
  >
    <h1 class="text-xl">Shuffles</h1>
    <button on:click={promptCreateShuffle} class="btn btn-sm variant-filled-surface"
      >Create shuffle</button
    >
  </div>

  <div class="flex-1 px-3 pb-3">
    <Accordion>
      {#each $shuffles?.filter((sh) => !sh.autoGeneratedForProfileId) ?? [] as shuffle}
        {@const enabled = $activeProfileStore.enabledShuffleIds.includes(shuffle.id)}
        <AccordionItem regionPanel="bg-surface-600/60 !rounded-2xl">
          <svelte:fragment slot="lead">
            <Dices
              size={16}
              class={classNames({
                'text-emerald-600': enabled,
                'text-red-600': !enabled
              })}
            />
          </svelte:fragment>
          <svelte:fragment slot="summary">{shuffle?.label ?? shuffle?.id}</svelte:fragment>
          <svelte:fragment slot="content">
            <div class="py-1">
              <div class="mb-2 flex justify-between items-center gap-2">
                <SlideToggle
                  size="sm"
                  active="bg-emerald-500"
                  name=""
                  background="bg-surface-400/40"
                  checked={enabled}
                  on:change={() => toggleShuffleEnabled(shuffle.id)}
                >
                  <!-- <span class="text-sm"> {shuffle.enabled ? 'Enabled' : 'Disabled'}</span> -->
                </SlideToggle>

                <div class="flex items-center gap-2">
                  <button
                    on:click={() => promptShuffleRename(shuffle.id, shuffle.label)}
                    class="btn btn-sm variant-filled-surface"
                  >
                    Rename
                  </button>

                  <button
                    on:click={() => promptShuffleDelete(shuffle.id, shuffle.label)}
                    class="btn btn-sm variant-filled-surface"
                  >
                    Delete
                  </button>
                </div>
              </div>

              <div
                class="flex flex-col rounded-md gap-2"
                on:dragover={(ev) => {
                  ev.preventDefault()
                }}
                on:drop={(e) => drop(e, shuffle.id)}
                class:dropActive={$isDraggingAddon}
              >
                {#if shuffle.shuffledAddonIds.length == 0}
                  <div class="text-left text-sm text-gray-400 p-2">
                    Drag and drop addons here to shuffle them
                  </div>
                {/if}

                {#each shuffle.shuffledAddonIds as addonId}
                  <div class="flex items-center justify-between">
                    <AddonCard
                      mode="in-shuffle-list"
                      addon={$currentGameManifest.addons.find((addon) => addon.id == addonId)}
                    />

                    <button
                      class="btn w-full max-w-[32px] btn-icon btn-sm variant-filled-surface"
                      on:click={() => toggleAddonIdInShuffle(shuffle.id, addonId)}
                    >
                      <TrashIcon size={16} />
                    </button>
                  </div>
                {/each}
              </div>
            </div>
          </svelte:fragment>
        </AccordionItem>
      {/each}
    </Accordion>
  </div>
</div>

<style lang="postcss">
  .dropActive {
    @apply outline-1  outline-dashed outline-primary-500;
  }
</style>
