<script lang="ts">
  import { SlideToggle } from '@skeletonlabs/skeleton'
  import games from 'shared/games'
  import { libraryActiveSubCategories, libraryActiveCategory } from '../../../../stores/library'
  import { db } from '../../../../db/db'
  import { activeProfileStore } from '../../../../stores/active-profile'
  import { toggleShuffleEnabled } from '../../../../utils/shuffles'
  import { liveQuery } from 'dexie'

  $: subCategory = $libraryActiveSubCategories[0] ?? undefined

  $: shuffle = liveQuery(() => {
    return db.shuffles
      .where('autoGeneratedForProfileId')
      .equals($activeProfileStore.id)
      .and((shuffle) => {
        return shuffle.autoGeneratedForSubCategory === subCategory
      })
      .first()
  })

  $: shuffleEnabled = $activeProfileStore.enabledShuffleIds.includes($shuffle?.id)

  async function createOrEnableSubCategoryShuffle() {
    // Create the shuffle if it doesn't exist already
    if (!$shuffle) {
      const newShuffle = await db.shuffles.add({
        shuffledAddonIds: [],
        label: subCategory,
        autoGeneratedForProfileId: $activeProfileStore.id,
        autoGeneratedForSubCategory: subCategory
      })

      console.log('created auto-generated subCategory shuffle', newShuffle)

      // Enable new shuffle
      toggleShuffleEnabled(newShuffle)
    } else {
      // Enable existing shuffle
      toggleShuffleEnabled($shuffle.id)
    }
  }

  function handleSubCategoryShuffleToggle() {
    if (!shuffleEnabled) createOrEnableSubCategoryShuffle()
    else toggleShuffleEnabled($shuffle.id)
  }

  $: activeSubCat = games[550].addons.categories
    .find((cat) => cat.id == $libraryActiveCategory)
    ?.subCategories.find((subCat) => subCat.id == $libraryActiveSubCategories[0])
</script>

{#if $libraryActiveSubCategories.length == 1}
  {#if activeSubCat?.allowSingleAddonRandomization}
    <div
      class="flex flex-col items-center justify-center ml-auto bg-surface-600 rounded-full pl-2 pr-4"
    >
      <SlideToggle
        active="bg-primary-500"
        name=""
        on:click={handleSubCategoryShuffleToggle}
        checked={shuffleEnabled}
      >
        <span class="text-sm">Shuffle</span>
      </SlideToggle>
    </div>
  {/if}
{/if}
