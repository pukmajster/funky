<script lang="ts">
  import { SlideToggle } from '@skeletonlabs/skeleton'
  import games from 'shared/games'
  import {
    isDraggingAddon,
    libraryActiveSubCategories,
    libraryActiveCategory
  } from '../../../../stores/library'
  import { db } from '../../../../db/db'
  import { activeProfileStore } from '../../../../stores/active-profile'
  import { toggleAddonIdInShuffle, toggleShuffleEnabled } from '../../../../utils/shuffles'
  import { liveQuery } from 'dexie'
  import { currentGameManifest } from '../../../../stores/manifest'
  import AddonCard from '../../../../components/addons/AddonCard.svelte'

  $: subCategory = $libraryActiveSubCategories[0] ?? undefined

  $: shuffle = liveQuery(() => {
    return db.shuffles
      .where('autoGeneratedForProfileId')
      .equals($activeProfileStore.id)
      .and((shuffle) => {
        return shuffle.autoGeneratedForSubCategory === subCategory
      })
      .first()
  })

  $: shuffleEnabled = $activeProfileStore.enabledShuffleIds.includes($shuffle?.id)

  async function createOrEnableSubCategoryShuffle() {
    // Create the shuffle if it doesn't exist already
    if (!$shuffle) {
      const newShuffle = await db.shuffles.add({
        shuffledAddonIds: [],
        label: subCategory,
        autoGeneratedForProfileId: $activeProfileStore.id,
        autoGeneratedForSubCategory: subCategory
      })

      console.log('created auto-generated subCategory shuffle', newShuffle)

      // Enable new shuffle
      toggleShuffleEnabled(newShuffle)
    } else {
      // Enable existing shuffle
      toggleShuffleEnabled($shuffle.id)
    }
  }

  function drop(event: DragEvent) {
    console.log(event)
    $isDraggingAddon = false
    const json = event.dataTransfer.getData('text/plain')
    const data = JSON.parse(json)

    if ($libraryActiveSubCategories.length == 0) return
    toggleAddonIdInShuffle($shuffle.id, data.addonId)

    event.preventDefault()
  }

  $: activeSubCat = games[550].addons.categories
    .find((cat) => cat.id == $libraryActiveCategory)
    ?.subCategories.find((subCat) => subCat.id == $libraryActiveSubCategories[0])
</script>

{#if $libraryActiveSubCategories.length == 1}
  {#if activeSubCat?.allowSingleAddonRandomization}
    {#if shuffleEnabled}
      <div
        id="LibraryToolbarSubCatShuffleZone"
        class:inactive={!shuffleEnabled}
        on:dragover={(ev) => {
          ev.preventDefault()
        }}
        on:drop={(e) => drop(e)}
      >
        <div class="flex justify-center gap-3 items-center max-xl:my-2 mb-1">
          <div class="flex-1 bg-surface-600 h-[1px]" />
          <div class=" font-semibold text-xs leading-none">{activeSubCat?.label} Shuffle</div>
          <div class="flex-1 bg-surface-600 h-[1px]" />
        </div>

        <div
          class:dropActive={$isDraggingAddon}
          class="z-10 px-2 flex-1 pt-1 pb-3 flex items-center w-full border-surface-500 rounded-md overflow-x-auto"
        >
          <div
            class:hidden={!activeSubCat?.allowSingleAddonRandomization}
            class=" min-h-[120px] max-h-[120px] z-10 after:h-[1px] after:z-40 after:left-[-22px] after:absolute after:top-[-2px] after:w-full after:bg-surface-700 after:content-[''] after:border-white border-2 border-transparent border-dotted"
          >
            <div class="">
              <div class="flex gap-2 w-full" class:grayscale={!shuffleEnabled}>
                {#each $shuffle?.shuffledAddonIds ?? [] as addonId}
                  {@const addonData = $currentGameManifest.addons.find(
                    (addon) => addon.id == addonId
                  )}
                  {#if addonData}
                    <AddonCard mode="card" asShuffle addon={addonData} />
                  {/if}
                {/each}
              </div>
            </div>
          </div>

          {#if $shuffle?.shuffledAddonIds.length == 0}
            <div class="flex-1 w-full text-center text-gray-400">
              Drag and drop mods here to shuffle them.
            </div>
          {/if}
        </div>
      </div>
    {/if}
  {/if}
{/if}

<style lang="postcss">
  .dropActive {
    @apply bg-primary-500/30;
  }

  .inactive {
    @apply hidden;
  }
</style>
